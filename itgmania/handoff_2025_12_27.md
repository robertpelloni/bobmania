# Handoff Document - December 27, 2025

## Session Overview
This session focused on addressing items from the `Docs/KnownIssues.txt` list. Several bugs were investigated and fixed, improving the stability and correctness of the game engine.

## Completed Tasks

### 1. Fix Warp Segments with C-Mods
*   **Issue**: C-Mods (Constant Scroll Speed) were ignoring Warp segments, causing notes to stack or desync visually.
*   **Fix**: Modified `src/ArrowEffects.cpp` to implement `GetUnwarpedTime`. This function adjusts the time used for C-Mod positioning to account for the time skipped by warps, ensuring notes are spaced correctly.

### 2. Fix Hold/Roll Head Draw Order
*   **Issue**: Hold and Roll heads were drawing underneath preceding tap notes on the same or nearby rows, causing visual confusion.
*   **Fix**:
    *   Modified `src/NoteDisplay.cpp` and `src/NoteDisplay.h`.
    *   Split `DrawHold` into `DrawHoldBody` and `DrawHoldHead`.
    *   Implemented `DrawMixedInRange` in `NoteColumnRenderer` to merge Taps and Hold Heads into a single list.
    *   Sorted the merged list by row/beat and drew them in order, ensuring correct Z-ordering (later notes on top of earlier notes).

### 3. Fix Split Timing with Single Chart
*   **Issue**: When only one chart was active (or in single-player), "Split Timing" (per-chart timing data) was not being correctly applied to the global game position, potentially causing sync issues if the chart had unique timing.
*   **Fix**:
    *   Modified `src/ScreenGameplay.cpp`.
    *   Updated `UpdateSongPosition` to check if all active players are using the same `Steps` (or if there's only one player).
    *   If so, the game now uses that `Steps`'s `TimingData` to update the global song position, instead of defaulting to the `Song`'s generic timing.

### 4. Fix Attacks Involving Noteskins
*   **Issue**: Attacks that changed the noteskin (e.g., `*4 noteskin=flat`) failed if the target noteskin wasn't already loaded in the cache.
*   **Fix**:
    *   Modified `src/NoteField.cpp`.
    *   Updated `NoteField::Update` to detect when the requested noteskin differs from the current one.
    *   Added a check to see if the new noteskin is cached. If not, it now calls `CacheNoteSkin` on the fly before attempting to switch.

### 5. Fix Routine Mode Jukebox Infinite Loop
*   **Issue**: When the Jukebox selected a Routine chart (which requires two players sharing sides), it could enter an infinite loop if it failed to find a valid song/chart combination, or recursively called `SetSong` without a break condition.
*   **Fix**:
    *   Modified `src/ScreenJukebox.cpp`.
    *   Refactored the fallback logic in `SetSong`.
    *   Added a `bTriedFallback` flag and a `goto TryAgain` label to ensure the fallback to Single style only happens once.
    *   Explicitly cleared `GAMESTATE->m_pCurSong` at the start of `SetSong` to prevent stale state.
    *   This prevents the infinite recursion that occurred when the game repeatedly tried to switch styles and find a song without success.

### 6. Fix Unlock Code Functionality
*   **Issue**: Unlock codes defined in metrics (e.g., `Unlock1Command=...;code,"Left,Right"`) were not working. The game had no mechanism to listen for these codes on the Title Menu.
*   **Fix**:
    *   Modified `src/UnlockManager.h` and `src/UnlockManager.cpp`.
    *   Added `InputQueueCode` to `UnlockEntry` to track the code sequence.
    *   Implemented `UnlockManager::Input` to check if any locked entry's code has been entered.
    *   Modified `src/ScreenTitleMenu.cpp` to call `UNLOCKMAN->Input(input)` in its `Input` handler.
    *   Now, when a user enters the correct code on the Title Menu, the content is unlocked, a sound plays, and a system message appears.

## Remaining Known Issues (from `Docs/KnownIssues.txt`)
*   **Course Editor**: Not working, needs rewrite.
*   **Scoring System**: Needs to be global, not theme-tied.
*   **Editor C/V Keys**: Attack-related keys need work/fixes.
*   **Japanese Fonts**: Maps are too large, need resizing/splitting.
*   **LuaDriver**: Latency issues due to lack of threading.
*   **3D Models**: Crash on some graphics cards.

## Next Steps
The recommended next task is to investigate the **Japanese Fonts** issue.
*   **Japanese Fonts**: "Japanese font maps are too large and get resized on load... They should be cut into thirds vertically."
    *   Likely Location: `Themes/_fallback/Fonts/` or `src/Font.cpp`.

## Repository Status
*   Local changes committed (pending push).
*   Submodules updated.
*   `Docs/KnownIssues.txt` updated to reflect completed work.
*   `VERSION.md` bumped to 1.2.6.
*   `CHANGELOG.md` updated.
*   `LLM_INSTRUCTIONS.md` consolidated and updated.
*   `Docs/ProjectDashboard.md` updated.
